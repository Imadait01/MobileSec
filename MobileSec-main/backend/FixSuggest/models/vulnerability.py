"""
FixSuggest - Modèles Pydantic
==============================
Définit les schémas de données pour les vulnérabilités et les suggestions.
"""

from pydantic import BaseModel, Field
from typing import List, Optional, Dict, Any
from enum import Enum
from datetime import datetime


class Severity(str, Enum):
    """Niveaux de sévérité des vulnérabilités"""
    CRITICAL = "critical"
    HIGH = "high"
    MEDIUM = "medium"
    LOW = "low"
    INFO = "info"


class Category(str, Enum):
    """Catégories de vulnérabilités"""
    CRYPTO = "cryptography"
    STORAGE = "storage"
    NETWORK = "network"
    AUTH = "authentication"
    CODE = "code-quality"
    PLATFORM = "platform"
    RESILIENCE = "resilience"
    PRIVACY = "privacy"


class Vulnerability(BaseModel):
    """
    Représente une vulnérabilité détectée.
    Format compatible avec la sortie de ReportGen.
    """
    id: str = Field(..., description="Identifiant unique de la vulnérabilité")
    title: Optional[str] = Field(None, description="Titre de la vulnérabilité")
    description: Optional[str] = Field(None, description="Description détaillée")
    severity: Optional[str] = Field("medium", description="Niveau de sévérité")
    category: Optional[str] = Field(None, description="Catégorie de vulnérabilité")
    file: Optional[str] = Field(None, description="Fichier affecté")
    line: Optional[int] = Field(None, description="Numéro de ligne")
    code_snippet: Optional[str] = Field(None, alias="codeSnippet", description="Extrait de code vulnérable")
    cwe: Optional[str] = Field(None, description="Identifiant CWE")
    tool: Optional[str] = Field(None, description="Outil ayant détecté la vulnérabilité")
    
    class Config:
        populate_by_name = True


class SuggestRequest(BaseModel):
    """
    Requête pour obtenir des suggestions de correction.
    """
    vulnerabilities: List[Vulnerability] = Field(
        ..., 
        description="Liste des vulnérabilités à analyser",
        min_length=1
    )
    scan_id: Optional[str] = Field(None, description="ID du scan associé")
    language: Optional[str] = Field("java", description="Langage de programmation cible")
    include_patches: bool = Field(True, description="Inclure les patches de code")
    
    class Config:
        json_schema_extra = {
            "example": {
                "vulnerabilities": [
                    {
                        "id": "vuln-001",
                        "title": "AES/ECB usage",
                        "description": "Utilisation du mode ECB non sécurisé",
                        "severity": "high",
                        "file": "CryptoUtils.java",
                        "line": 42,
                        "cwe": "CWE-327"
                    }
                ],
                "language": "java",
                "include_patches": True
            }
        }


class MASVSRule(BaseModel):
    """
    Représente une règle MASVS.
    """
    rule_id: str = Field(..., description="Identifiant de la règle (ex: MASVS-CRYPTO-01)")
    title: str = Field(..., description="Titre de la règle")
    description: Optional[str] = Field(None, description="Description de la règle")
    triggers: List[str] = Field(default=[], description="Patterns déclencheurs")
    recommendation: str = Field(..., description="Recommandation de base")
    patches: Optional[Dict[str, str]] = Field(default={}, description="Patches par langage")
    references: Optional[List[str]] = Field(default=[], description="Liens de référence")
    severity: Optional[str] = Field("medium", description="Sévérité par défaut")


class Suggestion(BaseModel):
    """
    Suggestion de correction pour une vulnérabilité.
    """
    vulnerability_id: str = Field(..., description="ID de la vulnérabilité concernée")
    vulnerability_title: Optional[str] = Field(None, description="Titre de la vulnérabilité")
    
    # Règle MASVS associée
    masvs_rule_id: Optional[str] = Field(None, description="ID de la règle MASVS")
    masvs_rule_title: Optional[str] = Field(None, description="Titre de la règle MASVS")
    
    # Recommandation enrichie par LLM
    original_recommendation: Optional[str] = Field(None, description="Recommandation MASVS originale")
    enriched_recommendation: str = Field(..., description="Recommandation enrichie par IA")
    
    # Patch de code
    patch_code: Optional[str] = Field(None, description="Code de correction suggéré")
    patch_language: Optional[str] = Field(None, description="Langage du patch")
    
    # Métadonnées
    confidence: float = Field(default=0.8, description="Score de confiance (0-1)")
    references: List[str] = Field(default=[], description="Références utiles")
    
    class Config:
        json_schema_extra = {
            "example": {
                "vulnerability_id": "vuln-001",
                "vulnerability_title": "AES/ECB usage",
                "masvs_rule_id": "MASVS-CRYPTO-01",
                "masvs_rule_title": "Strong Cryptography",
                "original_recommendation": "Utiliser AES/GCM au lieu d'ECB",
                "enriched_recommendation": "Remplacez AES/ECB par AES/GCM/NoPadding...",
                "patch_code": "Cipher cipher = Cipher.getInstance(\"AES/GCM/NoPadding\");",
                "patch_language": "java",
                "confidence": 0.95,
                "references": ["https://owasp.org/..."]
            }
        }


class SuggestResponse(BaseModel):
    """
    Réponse contenant toutes les suggestions.
    """
    status: str = Field(default="success", description="Statut de la requête")
    scan_id: Optional[str] = Field(None, description="ID du scan")
    total_processed: int = Field(default=0, description="Nombre de vulnérabilités analysées")
    total_suggestions: int = Field(default=0, description="Nombre de suggestions générées")
    suggestions: List[Suggestion] = Field(default=[], description="Liste des suggestions")
    processing_time_ms: Optional[int] = Field(None, description="Temps de traitement en ms")
    model_used: Optional[str] = Field(None, description="Modèle LLM utilisé")
    generated_at: str = Field(
        default_factory=lambda: datetime.utcnow().isoformat(),
        description="Date de génération"
    )
    
    class Config:
        json_schema_extra = {
            "example": {
                "status": "success",
                "scan_id": "abc-123",
                "total_processed": 5,
                "total_suggestions": 5,
                "suggestions": [],
                "processing_time_ms": 1234,
                "model_used": "amazon/nova-lite-v1",
                "generated_at": "2025-12-11T12:00:00Z"
            }
        }


class HealthResponse(BaseModel):
    """Réponse du endpoint health"""
    status: str = Field(default="healthy")
    service: str = Field(default="FixSuggest")
    version: str
    model: str = Field(description="Modèle LLM utilisé")
    llm_configured: bool = Field(default=True, description="Si le LLM est configuré")
    rules_loaded: int
    timestamp: str = Field(default_factory=lambda: datetime.utcnow().isoformat())


class ErrorResponse(BaseModel):
    """Réponse d'erreur"""
    status: str = Field(default="error")
    error: str
    detail: Optional[str] = None
    timestamp: str = Field(default_factory=lambda: datetime.utcnow().isoformat())
