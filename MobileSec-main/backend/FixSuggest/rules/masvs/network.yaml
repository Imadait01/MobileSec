# MASVS Network Rules - Règles de sécurité réseau
# Basé sur OWASP Mobile Application Security Verification Standard

rules:
  - id: MSTG-NETWORK-1
    masvs_category: "MSTG-NETWORK-1"
    title: "Communication non chiffrée (HTTP)"
    description: "L'application utilise HTTP au lieu de HTTPS, exposant les données en transit."
    severity: "CRITICAL"
    triggers:
      - "http://"
      - "HTTP_URL"
      - "cleartext"
      - "unencrypted_connection"
      - "insecure_connection"
      - "plain_http"
    remediation: |
      Toujours utiliser HTTPS pour les communications réseau.
      
      **Android (Network Security Config):**
      ```xml
      <network-security-config>
          <base-config cleartextTrafficPermitted="false">
              <trust-anchors>
                  <certificates src="system" />
              </trust-anchors>
          </base-config>
      </network-security-config>
      ```
      
      **Code:**
      ```java
      URL url = new URL("https://api.example.com/endpoint");
      HttpsURLConnection conn = (HttpsURLConnection) url.openConnection();
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"
      - "https://developer.android.com/training/articles/security-config"

  - id: MSTG-NETWORK-2
    masvs_category: "MSTG-NETWORK-2"
    title: "Absence de Certificate Pinning"
    description: "L'application ne vérifie pas le certificat du serveur, permettant des attaques MITM."
    severity: "HIGH"
    triggers:
      - "TrustAllCertificates"
      - "X509TrustManager"
      - "checkServerTrusted"
      - "ALLOW_ALL_HOSTNAME_VERIFIER"
      - "setHostnameVerifier"
      - "ssl_verification_disabled"
      - "verify=False"
      - "InsecureSkipVerify"
    remediation: |
      Implémenter le certificate pinning pour valider l'identité du serveur.
      
      **Android (Network Security Config):**
      ```xml
      <network-security-config>
          <domain-config>
              <domain includeSubdomains="true">api.example.com</domain>
              <pin-set expiration="2025-01-01">
                  <pin digest="SHA-256">base64EncodedPublicKeyHash</pin>
              </pin-set>
          </domain-config>
      </network-security-config>
      ```
      
      **OkHttp:**
      ```java
      CertificatePinner pinner = new CertificatePinner.Builder()
          .add("api.example.com", "sha256/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=")
          .build();
      OkHttpClient client = new OkHttpClient.Builder()
          .certificatePinner(pinner)
          .build();
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"
      - "https://developer.android.com/training/articles/security-config"

  - id: MSTG-NETWORK-3
    masvs_category: "MSTG-NETWORK-3"
    title: "Version TLS obsolète"
    description: "L'application utilise TLS 1.0 ou 1.1 qui sont obsolètes et vulnérables."
    severity: "HIGH"
    triggers:
      - "TLSv1.0"
      - "TLSv1.1"
      - "SSLv3"
      - "SSLv2"
      - "TLS_1_0"
      - "TLS_1_1"
      - "weak_tls"
      - "deprecated_ssl"
    remediation: |
      Utiliser TLS 1.2 ou TLS 1.3 minimum.
      
      **Java:**
      ```java
      SSLContext sslContext = SSLContext.getInstance("TLSv1.3");
      sslContext.init(null, null, new SecureRandom());
      
      HttpsURLConnection.setDefaultSSLSocketFactory(sslContext.getSocketFactory());
      ```
      
      **Android:**
      ```xml
      <application android:networkSecurityConfig="@xml/network_security_config">
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"

  - id: MSTG-NETWORK-4
    masvs_category: "MSTG-NETWORK-4"
    title: "WebView avec JavaScript activé sans contrôle"
    description: "WebView avec JavaScript activé peut être vulnérable aux attaques XSS et injection."
    severity: "MEDIUM"
    triggers:
      - "setJavaScriptEnabled(true)"
      - "addJavascriptInterface"
      - "WebView"
      - "loadUrl"
      - "evaluateJavascript"
    remediation: |
      Sécuriser les WebViews:
      - Désactiver JavaScript si non nécessaire
      - Valider toutes les URLs chargées
      - Ne pas exposer d'interfaces JavaScript sensibles
      
      **Android:**
      ```java
      WebSettings settings = webView.getSettings();
      settings.setJavaScriptEnabled(false); // Si possible
      settings.setAllowFileAccess(false);
      settings.setAllowContentAccess(false);
      
      webView.setWebViewClient(new WebViewClient() {
          @Override
          public boolean shouldOverrideUrlLoading(WebView view, String url) {
              // Valider l'URL avant de charger
              if (isAllowedUrl(url)) {
                  return false;
              }
              return true;
          }
      });
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"

  - id: MSTG-NETWORK-5
    masvs_category: "MSTG-NETWORK-5"
    title: "Fuite de données sensibles dans les logs réseau"
    description: "Les données sensibles sont journalisées lors des communications réseau."
    severity: "MEDIUM"
    triggers:
      - "Log.d"
      - "Log.v"
      - "print("
      - "console.log"
      - "logging"
      - "network_log"
      - "request_body"
      - "response_body"
    remediation: |
      Ne pas journaliser de données sensibles en production.
      
      **Android:**
      ```java
      if (BuildConfig.DEBUG) {
          Log.d(TAG, "Debug info: " + sanitizedData);
      }
      
      // Utiliser un intercepteur OkHttp conditionnel
      if (BuildConfig.DEBUG) {
          HttpLoggingInterceptor logging = new HttpLoggingInterceptor();
          logging.setLevel(HttpLoggingInterceptor.Level.BODY);
          builder.addInterceptor(logging);
      }
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"

  - id: MSTG-NETWORK-6
    masvs_category: "MSTG-NETWORK-6"
    title: "Exposition d'endpoints API internes"
    description: "Des URLs d'API internes ou de développement sont présentes dans le code."
    severity: "MEDIUM"
    triggers:
      - "localhost"
      - "127.0.0.1"
      - "192.168."
      - "10.0."
      - "internal_api"
      - "dev_server"
      - "staging"
      - "test_url"
    remediation: |
      Utiliser des configurations d'environnement pour gérer les URLs.
      
      **Android:**
      ```java
      public class ApiConfig {
          public static String getBaseUrl() {
              if (BuildConfig.DEBUG) {
                  return BuildConfig.DEV_API_URL;
              }
              return BuildConfig.PROD_API_URL;
          }
      }
      ```
      
      **build.gradle:**
      ```groovy
      buildTypes {
          debug {
              buildConfigField "String", "API_URL", "\"https://dev-api.example.com\""
          }
          release {
              buildConfigField "String", "API_URL", "\"https://api.example.com\""
          }
      }
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"
