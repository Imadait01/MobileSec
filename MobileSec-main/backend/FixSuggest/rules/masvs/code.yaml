# MASVS Code Rules - Règles de qualité et sécurité du code
# Basé sur OWASP Mobile Application Security Verification Standard

rules:
  - id: MSTG-CODE-1
    masvs_category: "MSTG-CODE-1"
    title: "Injection SQL"
    description: "L'application est vulnérable aux injections SQL."
    severity: "CRITICAL"
    triggers:
      - "rawQuery"
      - "execSQL"
      - "executeQuery"
      - "sql_injection"
      - "string concatenation"
      - "+ query"
      - "\"SELECT"
      - "\"INSERT"
      - "\"UPDATE"
      - "\"DELETE"
    remediation: |
      Utiliser des requêtes paramétrées (prepared statements).
      
      **Android/Java:**
      ```java
      // ❌ Vulnérable
      String query = "SELECT * FROM users WHERE username = '" + username + "'";
      cursor = db.rawQuery(query, null);
      
      // ✅ Sécurisé
      String query = "SELECT * FROM users WHERE username = ?";
      cursor = db.rawQuery(query, new String[]{username});
      
      // Room (recommandé)
      @Query("SELECT * FROM users WHERE username = :username")
      User findByUsername(String username);
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"
      - "https://cheatsheetseries.owasp.org/cheatsheets/SQL_Injection_Prevention_Cheat_Sheet.html"

  - id: MSTG-CODE-2
    masvs_category: "MSTG-CODE-2"
    title: "Exécution de code dynamique"
    description: "L'application charge ou exécute du code dynamiquement."
    severity: "HIGH"
    triggers:
      - "DexClassLoader"
      - "PathClassLoader"
      - "loadClass"
      - "Class.forName"
      - "Runtime.exec"
      - "ProcessBuilder"
      - "eval"
      - "reflection"
    remediation: |
      Éviter l'exécution de code dynamique ou valider rigoureusement les sources.
      
      **Android:**
      ```java
      // ❌ Éviter si possible
      DexClassLoader loader = new DexClassLoader(dexPath, ...);
      
      // ✅ Si nécessaire, valider la signature
      public boolean verifyDexSignature(File dexFile) {
          try {
              // Vérifier la signature du fichier DEX
              byte[] expectedHash = getExpectedHash();
              byte[] actualHash = computeSHA256(dexFile);
              return MessageDigest.isEqual(expectedHash, actualHash);
          } catch (Exception e) {
              return false;
          }
      }
      
      // ✅ Utiliser des fonctionnalités natives plutôt que Runtime.exec
      // Au lieu de: Runtime.getRuntime().exec("ping " + host)
      // Utiliser: InetAddress.getByName(host).isReachable(timeout)
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"

  - id: MSTG-CODE-3
    masvs_category: "MSTG-CODE-3"
    title: "Débogage activé en production"
    description: "Le mode debug est activé dans l'application de production."
    severity: "MEDIUM"
    triggers:
      - "debuggable"
      - "android:debuggable=\"true\""
      - "DEBUG"
      - "isDebuggable"
      - "BuildConfig.DEBUG"
    remediation: |
      Désactiver le debug en production.
      
      **AndroidManifest.xml:**
      ```xml
      <application
          android:debuggable="false"
          ...>
      ```
      
      **build.gradle:**
      ```groovy
      buildTypes {
          release {
              debuggable false
              minifyEnabled true
              proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
          }
      }
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"

  - id: MSTG-CODE-4
    masvs_category: "MSTG-CODE-4"
    title: "Composants exportés sans protection"
    description: "Des composants Android sont exportés sans vérification de permissions."
    severity: "HIGH"
    triggers:
      - "exported=\"true\""
      - "android:exported"
      - "intent-filter"
      - "BroadcastReceiver"
      - "ContentProvider"
      - "Service"
    remediation: |
      Protéger les composants exportés avec des permissions.
      
      **AndroidManifest.xml:**
      ```xml
      <!-- Définir une permission personnalisée -->
      <permission
          android:name="com.example.SECURE_PERMISSION"
          android:protectionLevel="signature" />
      
      <!-- Protéger le composant -->
      <activity
          android:name=".SecureActivity"
          android:exported="true"
          android:permission="com.example.SECURE_PERMISSION">
      </activity>
      
      <!-- Pour les ContentProviders -->
      <provider
          android:name=".SecureProvider"
          android:exported="true"
          android:readPermission="com.example.READ_DATA"
          android:writePermission="com.example.WRITE_DATA">
      </provider>
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"
      - "https://developer.android.com/guide/topics/manifest/activity-element"

  - id: MSTG-CODE-5
    masvs_category: "MSTG-CODE-5"
    title: "Validation d'entrée insuffisante"
    description: "Les entrées utilisateur ne sont pas validées correctement."
    severity: "HIGH"
    triggers:
      - "getText()"
      - "getIntent()"
      - "getExtras()"
      - "getQueryParameter"
      - "user_input"
      - "input_validation"
      - "EditText"
    remediation: |
      Valider et assainir toutes les entrées utilisateur.
      
      **Android:**
      ```java
      public class InputValidator {
          private static final Pattern SAFE_TEXT = Pattern.compile("^[a-zA-Z0-9\\s._-]{1,100}$");
          private static final Pattern EMAIL = Pattern.compile(
              "^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+$");
          
          public static String sanitizeText(String input) {
              if (input == null) return "";
              // Supprimer les caractères dangereux
              return input.replaceAll("[<>\"'&]", "");
          }
          
          public static boolean isValidEmail(String email) {
              return email != null && EMAIL.matcher(email).matches();
          }
          
          public static boolean isSafeText(String text) {
              return text != null && SAFE_TEXT.matcher(text).matches();
          }
      }
      
      // Utilisation
      String userInput = editText.getText().toString();
      if (!InputValidator.isSafeText(userInput)) {
          showError("Caractères non autorisés");
          return;
      }
      String sanitized = InputValidator.sanitizeText(userInput);
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"
      - "https://cheatsheetseries.owasp.org/cheatsheets/Input_Validation_Cheat_Sheet.html"

  - id: MSTG-CODE-6
    masvs_category: "MSTG-CODE-6"
    title: "Gestion d'exceptions révélant des informations"
    description: "Les messages d'erreur révèlent des informations sensibles."
    severity: "MEDIUM"
    triggers:
      - "printStackTrace"
      - "e.getMessage()"
      - "Exception"
      - "catch"
      - "error_message"
      - "stack_trace"
    remediation: |
      Journaliser les erreurs de manière sécurisée sans exposer de détails.
      
      **Android:**
      ```java
      try {
          // Code risqué
      } catch (Exception e) {
          // ❌ Ne pas faire
          Log.e(TAG, e.getMessage());
          e.printStackTrace();
          showError(e.getMessage());
          
          // ✅ Faire plutôt
          if (BuildConfig.DEBUG) {
              Log.e(TAG, "Error details", e);
          }
          // Logger vers un service sécurisé
          CrashReporting.logException(e);
          // Afficher un message générique
          showError("Une erreur s'est produite. Veuillez réessayer.");
      }
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"

  - id: MSTG-CODE-7
    masvs_category: "MSTG-CODE-7"
    title: "Deep Links non sécurisés"
    description: "Les deep links peuvent être exploités pour accéder à des fonctionnalités non autorisées."
    severity: "HIGH"
    triggers:
      - "deep_link"
      - "intent-filter"
      - "android:scheme"
      - "host"
      - "pathPattern"
      - "getIntent().getData()"
    remediation: |
      Valider les deep links et protéger les destinations sensibles.
      
      **AndroidManifest.xml:**
      ```xml
      <activity android:name=".DeepLinkActivity">
          <intent-filter android:autoVerify="true">
              <action android:name="android.intent.action.VIEW" />
              <category android:name="android.intent.category.DEFAULT" />
              <category android:name="android.intent.category.BROWSABLE" />
              <data android:scheme="https"
                    android:host="www.example.com"
                    android:pathPrefix="/app" />
          </intent-filter>
      </activity>
      ```
      
      **Activity:**
      ```java
      @Override
      protected void onCreate(Bundle savedInstanceState) {
          super.onCreate(savedInstanceState);
          
          Uri data = getIntent().getData();
          if (data != null) {
              // Valider le scheme et l'host
              if (!"https".equals(data.getScheme()) ||
                  !"www.example.com".equals(data.getHost())) {
                  finish();
                  return;
              }
              
              // Valider et assainir les paramètres
              String action = data.getQueryParameter("action");
              if (!isValidAction(action)) {
                  finish();
                  return;
              }
              
              // Vérifier l'authentification si nécessaire
              if (requiresAuth(action) && !isUserAuthenticated()) {
                  redirectToLogin();
                  return;
              }
              
              handleDeepLink(data);
          }
      }
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"
      - "https://developer.android.com/training/app-links/deep-linking"
