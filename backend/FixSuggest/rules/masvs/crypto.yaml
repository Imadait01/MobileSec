# MASVS Crypto Rules - Règles de cryptographie
# Basé sur OWASP Mobile Application Security Verification Standard

rules:
  - id: MSTG-CRYPTO-1
    masvs_category: "MSTG-CRYPTO-1"
    title: "Utilisation de cryptographie obsolète - MD5"
    description: "MD5 est un algorithme de hachage cryptographiquement cassé et ne doit plus être utilisé."
    severity: "HIGH"
    triggers:
      - "MD5"
      - "md5"
      - "MessageDigest.getInstance(\"MD5\")"
      - "hashlib.md5"
      - "crypto/md5"
      - "Ljavax/crypto.*MD5"
      - "weak_hash"
    remediation: |
      Remplacer MD5 par un algorithme de hachage sécurisé comme SHA-256 ou SHA-3.
      
      **Java:**
      ```java
      MessageDigest digest = MessageDigest.getInstance("SHA-256");
      byte[] hash = digest.digest(data.getBytes(StandardCharsets.UTF_8));
      ```
      
      **Python:**
      ```python
      import hashlib
      hash = hashlib.sha256(data.encode()).hexdigest()
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"
      - "https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html"

  - id: MSTG-CRYPTO-2
    masvs_category: "MSTG-CRYPTO-1"
    title: "Utilisation de cryptographie obsolète - SHA1"
    description: "SHA1 est considéré comme cryptographiquement faible et vulnérable aux attaques de collision."
    severity: "HIGH"
    triggers:
      - "SHA1"
      - "SHA-1"
      - "sha1"
      - "MessageDigest.getInstance(\"SHA-1\")"
      - "hashlib.sha1"
      - "crypto/sha1"
      - "Ljavax/crypto.*SHA1"
    remediation: |
      Remplacer SHA1 par SHA-256 ou SHA-3.
      
      **Java:**
      ```java
      MessageDigest digest = MessageDigest.getInstance("SHA-256");
      ```
      
      **Python:**
      ```python
      import hashlib
      hash = hashlib.sha256(data.encode()).hexdigest()
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"

  - id: MSTG-CRYPTO-3
    masvs_category: "MSTG-CRYPTO-2"
    title: "Mode AES-ECB non sécurisé"
    description: "Le mode ECB (Electronic Codebook) chiffre les blocs identiques de la même manière, révélant des patterns dans les données."
    severity: "HIGH"
    triggers:
      - "AES/ECB"
      - "ECB"
      - "Cipher.getInstance(\"AES/ECB"
      - "AES.MODE_ECB"
      - "insecure_cipher_mode"
      - "Ljavax/crypto/Cipher.*ECB"
    remediation: |
      Utiliser AES en mode GCM (Galois/Counter Mode) qui fournit confidentialité et intégrité.
      
      **Java:**
      ```java
      Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
      GCMParameterSpec spec = new GCMParameterSpec(128, iv);
      cipher.init(Cipher.ENCRYPT_MODE, key, spec);
      ```
      
      **Python:**
      ```python
      from cryptography.hazmat.primitives.ciphers.aead import AESGCM
      aesgcm = AESGCM(key)
      ciphertext = aesgcm.encrypt(nonce, plaintext, associated_data)
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"
      - "https://cheatsheetseries.owasp.org/cheatsheets/Cryptographic_Storage_Cheat_Sheet.html"

  - id: MSTG-CRYPTO-4
    masvs_category: "MSTG-CRYPTO-2"
    title: "Mode DES/3DES obsolète"
    description: "DES et 3DES sont des algorithmes de chiffrement obsolètes avec une taille de clé insuffisante."
    severity: "HIGH"
    triggers:
      - "DES"
      - "DESede"
      - "3DES"
      - "TripleDES"
      - "Cipher.getInstance(\"DES"
      - "Ljavax/crypto.*DES"
    remediation: |
      Remplacer DES/3DES par AES-256.
      
      **Java:**
      ```java
      KeyGenerator keyGen = KeyGenerator.getInstance("AES");
      keyGen.init(256);
      SecretKey key = keyGen.generateKey();
      Cipher cipher = Cipher.getInstance("AES/GCM/NoPadding");
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"

  - id: MSTG-CRYPTO-5
    masvs_category: "MSTG-CRYPTO-3"
    title: "Clé cryptographique en dur dans le code"
    description: "Les clés cryptographiques ne doivent jamais être codées en dur dans le code source."
    severity: "CRITICAL"
    triggers:
      - "hardcoded_key"
      - "hardcoded_secret"
      - "SecretKeySpec"
      - "private_key"
      - "api_key"
      - "secret_key"
      - "encryption_key"
      - "AES_KEY"
      - "RSA_PRIVATE"
    remediation: |
      Stocker les clés dans un système sécurisé:
      - Android Keystore pour les applications mobiles
      - AWS Secrets Manager ou HashiCorp Vault pour les backends
      - Variables d'environnement pour le développement
      
      **Android:**
      ```java
      KeyStore keyStore = KeyStore.getInstance("AndroidKeyStore");
      keyStore.load(null);
      SecretKey key = (SecretKey) keyStore.getKey("my_key_alias", null);
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"
      - "https://developer.android.com/training/articles/keystore"

  - id: MSTG-CRYPTO-6
    masvs_category: "MSTG-CRYPTO-4"
    title: "Génération de nombres aléatoires non sécurisée"
    description: "L'utilisation de Random() au lieu de SecureRandom() pour la cryptographie est une faille de sécurité."
    severity: "HIGH"
    triggers:
      - "java.util.Random"
      - "Math.random"
      - "random.random"
      - "weak_random"
      - "insecure_random"
      - "Ljava/util/Random"
    remediation: |
      Utiliser un générateur de nombres aléatoires cryptographiquement sécurisé.
      
      **Java:**
      ```java
      SecureRandom secureRandom = new SecureRandom();
      byte[] randomBytes = new byte[32];
      secureRandom.nextBytes(randomBytes);
      ```
      
      **Python:**
      ```python
      import secrets
      token = secrets.token_hex(32)
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"

  - id: MSTG-CRYPTO-7
    masvs_category: "MSTG-CRYPTO-5"
    title: "Taille de clé RSA insuffisante"
    description: "Les clés RSA de moins de 2048 bits sont considérées comme faibles."
    severity: "MEDIUM"
    triggers:
      - "RSA/1024"
      - "keysize=1024"
      - "weak_rsa"
      - "small_key"
    remediation: |
      Utiliser des clés RSA d'au moins 2048 bits, ou préférablement 4096 bits.
      
      **Java:**
      ```java
      KeyPairGenerator keyGen = KeyPairGenerator.getInstance("RSA");
      keyGen.initialize(4096, new SecureRandom());
      KeyPair keyPair = keyGen.generateKeyPair();
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"

  - id: MSTG-CRYPTO-8
    masvs_category: "MSTG-CRYPTO-6"
    title: "IV (Vecteur d'Initialisation) statique ou prévisible"
    description: "Un IV statique ou prévisible compromet la sécurité du chiffrement."
    severity: "HIGH"
    triggers:
      - "static_iv"
      - "iv = new byte"
      - "IV = \"0000"
      - "fixed_iv"
      - "hardcoded_iv"
    remediation: |
      Générer un IV aléatoire pour chaque opération de chiffrement.
      
      **Java:**
      ```java
      SecureRandom random = new SecureRandom();
      byte[] iv = new byte[16];
      random.nextBytes(iv);
      IvParameterSpec ivSpec = new IvParameterSpec(iv);
      ```
    references:
      - "https://owasp.org/www-project-mobile-top-10/"
